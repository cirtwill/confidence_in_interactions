
\documentclass[12pt]{article} 
\usepackage{amsmath} 
\usepackage[dvips]{graphicx}
\usepackage{multirow} 
\usepackage{geometry} 
\usepackage{pdflscape}
\usepackage[labelfont=bf]{caption} 
\usepackage{setspace}
\usepackage[running]{lineno} 
% \usepackage[numbers,sort]{natbib}
\usepackage[round]{natbib} 
\usepackage{array}

\newcommand{\methods}{\textit{Materials \& Methods}}
\newcommand{\SI}{\textit{Appendix}~}

\topmargin -1.5cm % 0.0cm 
\oddsidemargin 0.0cm % 0.2cm 
\textwidth 6.5in
\textheight 9.0in % 21cm
\footskip 1.0cm % 1.0cm

\usepackage{authblk}

\title{Supplemental information}


\author{Authors}
\date{\small$^1$Department of Physics, Chemistry\\ 
and Biology (IFM)\\ 
Link\"{o}ping University\\
Link\"{o}ping, Sweden\\
% \medskip
% $^\dagger$ Corresponding author:\\
% alyssa.cirtwill@gmail.com\\
% +46 723 158464\\
 }

\renewcommand\Authands{ and }

\begin{document} 
\maketitle 
\raggedright
\setlength{\parindent}{15pt} 
\clearpage

\section*{Appendix S1: Calculating posterior distributions and confidence intervals}

  The following simple functions are implemented in the R language. They are 
  also provided as R code in a separate file.
  Priordata is the list of interaction frequencies from the prior 
  data, n is the number of sites with observed co-occurrance of 
  species $i$ and $j$, and k is the number of sites with an 
  observed interaction $ij$. When calculating the prior 
  distribution, both n and k are 0. In the main text we assume 100\%
  confidence in observed interactions and therefore consider only 
  cases where k=0. Only n varies between species pairs.


  To calculate the parameters $\alpha$ and $\beta$ of a prior or 
  posterior distribution:

  \vspace{12pt}
  \begin{em}
  \noindent \hspace{2pt}calculate\_parameters\textless-function(priordata,n,k)\{\\
  \vspace{4pt}
    \# Calculate prior parameters\\
    start=list(shape1=1,shape2=1)\\
    pars=fitdistr(x=priordata,`beta',start=start,lower=c(0,0))\$estimate\\
    alpha=pars[[1]]\\
    beta=pars[[2]]\\
  \vspace{4pt}
    \# Update the parameters with data. If n=0 and k=0, no change.\\
    alpha\_prime=alpha+k\\
    beta\_prime=beta+n-k\\
    pars2=c(alpha\_prime,beta\_prime)\\
    return(pars2) \}
  \end{em}
  \vspace{12pt}


    All of the following functions use the parameters returned by 
    ``calculate\_parameters". To calculate the maximum likelihood estimates of 
    the mean and variance of the probability of interaction $\lambda_{ij}$:

    \vspace{12pt}
    \begin{em}
    \noindent \hspace{2pt}calculate\_distribution\textless-function(pars)\{\\
     \vspace{4pt}
     \# alpha and beta may be from a prior or posterior distribution\\
      alpha=pars[[1]]\\
      beta=pars[[2]]\\
      \vspace{4pt}
      \# Calculate the MLE of the mean\\
      mu\_numerator=alpha\\
      mu\_denominator=alpha+beta\\
      mu=mu\_numerator/mu\_denomenator\\
      \vspace{4pt}
      \# Calculate the MLE of the variance\\
      sig\_numerator=alpha\*beta\\
      den1=alpha+beta\\
      den2=den1$**$2\\
      sig\_denomenator=den1$*$den2\\
      sigma2=sig\_numerator/sig\_denomenator\\
      return(c(mu,sigma2))\}
    \end{em}
  \vspace{12pt}
      
  \clearpage

  To calculate a credible interval based on the prior or posterior distribution, for given lower and upper bounds:


  \vspace{12pt}
  \begin{em}
  \noindent \hspace{2pt}credible\_interval\textless-function(pars,p\_lower,p\_upper)\{\\
    \vspace{4pt}
    alpha=pars[[1]]\\
    beta=pars[[2]]\\
    lowCI=qbeta(p=p\_lower,shape1=alpha,shape2=beta)\\
    highCI=qbeta(p=p\_upper,shape1=alpha,shape2=beta)\\
    return(c(lowCI,highCI))\}
  \end{em}
  \vspace{12pt}

  To calculate the number of samples required to reach a given level of confidence that the probability of interaction between two species ($\lambda_{ij}$) that have not been observed co-occurring is below a threshold value:


  \vspace{12pt}
  \begin{em}
  \noindent \hspace{2pt}samples\_for\_threshold\textless-function(threshold,confidence,pars)\{\\
    \vspace{4pt}
    alpha=pars[[1]]\\
    beta=pars[[2]]\\
    n=seq(0,100,1)\\
    k=0\\ 
    cdf=pbeta(threshold,shape1=alpha,shape2=beta+n)\\
    samples=length(which(cdf\textless confidence))\\
    return(samples) \}
  \end{em}


\clearpage

\section*{Appendix S2: Details of \emph{Salix} data collection}

      The \emph{Salix}-galler-parasitoid meta-network dataset collected 
      by~\citet{Kopelke2017} consists of a single community type sampled across 
      Europe: willow (\emph{Salix}) species, willow-galling sawflies (
      Hymenoptera, Tenthredinidae, Nematinae, Euurina), and their natural 
      enemies (hymenopteran parasitoids and coleopteran, lepidopteran, dipteran, 
      and hymenopteran inquilines). The data were collected over 29 years 
      (1982-2010) at 374 unique locations across Europe ranging from Sicily to 
      the Arctic. Including repeated visits to a number of sites, the data set 
      contains 641 site-visits, each of which can be considered as a network in 
      its own right and an independent sample from which to build the 
      meta-network. The meta-network consists of 1,173 different interactions 
      between 52 \emph{Salix} nodes, 92 herbivore nodes, and 126 parasitoid 
      nodes. Interactions were determined by dissecting and rearing gall 
      inhabitants from 165,424 galls. Some sites were visited repeatedly, for a 
      total of 641 site-visits. We consider these to be repeated samples and 
      take the 374 unique sites as our sample size. The high spatiotemporal 
      resolution of this network and the unusually high sampling effort together 
      make this dataset particularly well suited for testing Bayesian approaches 
      to network structure.


\clearpage


\section*{Appendix S3: Obtaining prior interaction probabilities}

    \subsection*{Degree distributions and interaction probabilities}

      Obtaining degree distributions from the binary interaction 
      network is straightforward. To do this, we simply divide the 
      total number of observed interaction partners for each 
      species (row or column sums) with the number of potential 
      interaction partners (number of column or rows). Degree 
      distributions calculated, we can then calculate the 
      probability of each interaction as the product of the 
      normalised degrees of the two species. For example, the 
      probability of an interaction between two species with 
      normalised degrees of 0.5 (each interacts with half of the 
      available partners) is 0.25. R code used to do this follows:


      \vspace{12pt}
      \begin{em}
      \noindent \hspace{2pt}\# Now get the degree distributions from the web\\
      \noindent \hspace{2pt}deg\_dist\_Salix=rowSums(prior\_web)/ncol(prior\_web)\\
      \vspace{4pt}
      \noindent \hspace{2pt}\# Remove one genotype that never interacted\\
      \noindent \hspace{2pt}deg\_dist\_Salix\textless-deg\_dist\_Salix[which(rowSums(prior\_web)\textgreater0)]\\
      \noindent \hspace{2pt}deg\_dist\_galler=colSums(prior\_web)/nrow(prior\_web)\\
      \vspace{4pt}
      \noindent \hspace{2pt}\# Interaction probabilities are the product of plant and galler probabilities\\
      \noindent \hspace{2pt}int\_probs=as.numeric(deg\_dist\_galler\%$*$\%t(deg\_dist\_Salix))\\
      \vspace{4pt}
      \noindent \hspace{2pt}\# And for the galler-parasitoid web:\\
      \noindent \hspace{2pt}deg\_dist\_parasitoid=rowSums(prior\_web\_para\_only)/ncol(prior\_web\_para\_only)\\
      \noindent \hspace{2pt}deg\_dist\_parasitized=colSums(prior\_web\_para\_only)/nrow(prior\_web\_para\_only)\\
      \noindent \hspace{2pt}gp\_int\_probs=as.numeric(deg\_dist\_parasitized\%$*$\%t(deg\_dist\_parasitoid))\\
      \end{em}


      % SG_web=read.csv('binary_prior_web_SG.csv',row.names=1)
      % GP_web=read.csv('binary_prior_web_para_only.csv',row.names=1)

      %       # Now get the degree distributions from the web
      % deg_dist_Salix=rowSums(SG_web)/ncol(SG_web)
      % deg_dist_galler=colSums(SG_web)/nrow(SG_web)
      % # Interaction probabilities are the product of plant and galler probabilities
      % sg_int_probs=as.numeric(deg_dist_galler%*%t(deg_dist_Salix))

      % deg_dist_parasitoid=rowSums(GP_web)/ncol(GP_web)
      % deg_dist_parasitized=colSums(GP_web)/nrow(GP_web)
      % gp_int_probs=as.numeric(deg_dist_parasitized%*%t(deg_dist_parasitoid))


\clearpage

\section*{Appendix S4: Analyses using alternative prior}

  We repeated our analyses using an alternative prior derived from a study of a similar \emph{Salix}-galler-natural enemy system in North America~\citep{Barbour2016,Barbour2016Dryad}. We note that this study used several genotypes of \emph{Salix hookeriana} rather than different \emph{Salix} species and so did not produce networks of similar size and connectedness to those in~\citep{Kopelke2016}.  To obtain the priors based on~\citet{Barbour2016}, we estimated frequencies of  \emph{S. hookeriana} genotype-galler interactions based on the normalised degree of each node (species or genotype) in each network component.

    \subsection*{Creating a binary interaction network}

      \citet{Barbour2016,Barbour2016Dryad} sampled 145 branches from 
      \emph{Salix hookeriana} of 26 genotypes. They recorded galls 
      made by four species of Cecidomyid midges on each branch. We 
      transformed these data to a binary genotype-galler network 
      matrix, where an entry $ij$ was 1 if galler $i$ was observed 
      on any branch of genotype $j$ and 0 otherwise. In total, this 
      network contained 75 realised galler-genotype interactions 
      out of a potential 104. One \emph{S. hookeriana} genotype did
      not interact with any gallers and was removed from the network.
      The R code used to extract this 
      network follows:


      \vspace{12pt}
      \begin{em}
      \noindent \hspace{2pt}prior\_web\_data=read.csv(``tree\_level\_interaxn\_all\_plants\_traits\_size.csv")\\
      \vspace{4pt}
      \noindent \hspace{2pt}\# Remove extra data on parasitoids, etc.\\
      \noindent \hspace{2pt}prior\_web\_data[,31:57]\textless-NULL\\
      \noindent \hspace{2pt}prior\_web\_data[,4:26]\textless-NULL\\
      \noindent \hspace{2pt}prior\_web\_data[,2]\textless-NULL\\
      \vspace{4pt}
      \noindent \hspace{2pt}\# Build a web with interactions=1 for any galler observed on any genotype\\
      \noindent \hspace{2pt}prior\_web=matrix(nrow=26,ncol=4)\\
      \noindent \hspace{2pt}for(r in 1:length(levels(prior\_web\_data\$Genotype)))\{\\
      \hspace{4pt}gen=levels(prior\_web\_data\$Genotype)[r]\\
      \hspace{4pt}subset=prior\_web\_data[which(prior\_web\_data\$Genotype==gen),]\\
      \hspace{4pt}for(c in 1:4)\{\\
      \hspace{8pt}if(sum(subset[,2+c])\textgreater0)\{\\
      \hspace{12pt}prior\_web[r,c]=1\\
      \hspace{8pt}\} else \{\\
      \hspace{12pt}prior\_web[r,c]=0\\
      \hspace{8pt}\}\}\}\\
      \vspace{4pt}
      \noindent \hspace{2pt}\# Remove non-interactive genotype to obtain the final web\\
      \noindent \hspace{2pt}prior\_web\textless-prior\_web[which(rowSums(prior\_web)\textgreater0),]
      \end{em}

      % prior_web_data=read.csv('../../data/Salix_example/tree_level_interaxn_all_plants_traits_size.csv')
      % # Remove extra data on parasitoids, etc.
      % prior_web_data[,31:57]<-NULL
      % prior_web_data[,4:26]<-NULL
      % prior_web_data[,2]<-NULL
      % # Build a web with interactions=1 for any galler observed on any genotype
      % prior_web=matrix(nrow=26,ncol=4)
      % for(r in 1:length(levels(prior_web_data$Genotype))){
      %   gen=levels(prior_web_data$Genotype)[r]
      %   subset=prior_web_data[which(prior_web_data$Genotype==gen),]
      %   for(c in 1:4){
      %     if(sum(subset[,2+c])>0){
      %       prior_web[r,c]=1
      %     } else {
      %       prior_web[r,c]=0
      %     }
      %   }        
      % }
      % prior_web<-prior_web[which(rowSums(prior_web)>0),]
      % write.csv(prior_web,file='binary_prior_web_SG.csv',quote=F)

      \vspace{12pt}
      \clearpage

      To extract the galler-parsitoid network from the same study above:


      \vspace{12pt}
      \begin{em}
      \noindent \hspace{2pt}prior\_web\_data=read.csv(``tree\_level\_interaxn\_all\_plants\_traits\_size.csv")\\
      \noindent \hspace{2pt}prior\_web\_data \textless- prior\_web\_data[,8:26]\\
      \vspace{4pt}
      \noindent \hspace{2pt}\# Build a web with interactions=1 for any parasitoid on any galler\\
      \noindent \hspace{2pt}prior\_web=data.frame()\\
      \vspace{4pt}
      \noindent \hspace{2pt}\# each column contains all interactions for a \noindent \hspace{2pt}particular parasitoid-galler combination\\
      \noindent \hspace{2pt}for(column in 1:ncol(prior\_web\_data))\{\\
      \hspace{4pt}\# the column name gives the species which makes the gall,\\
      \hspace{4pt}\#followed by the species emerging from the gall\\
      \hspace{4pt}galler\_emerged=strsplit(colnames(prior\_web\_data)[column], "\_")\\
      \hspace{4pt}galler = galler\_emerged[[1]][1]\\
      \hspace{4pt}emerged = galler\_emerged[[1]][2]\\
      \vspace{4pt}
      \hspace{4pt}\# the strength of the interaction is the sum of the column\\
      \hspace{4pt}(number of galls across all branches sampled)\\
      \hspace{4pt}linkstrength = sum(prior\_web\_data[,column])\\
      \hspace{4pt}prior\_web[as.character(galler),as.character(emerged)] \textless- linkstrength\\
      \}\\
      \vspace{4pt}
      \noindent \hspace{2pt}\# Make the NAs into 0\\
      \noindent \hspace{2pt}prior\_web[is.na(prior\_web)] \textless- 0\\
      \vspace{4pt}
      \noindent \hspace{2pt}\# remove emerging gallers with no parasitoids\\
      \noindent \hspace{2pt}prior\_web\_para\_only \textless- prior\_web[,c(2:6,8:9,12)]\\
      \vspace{4pt}
      \noindent \hspace{2pt}\# convert interaction strengths to 1\\
      \noindent \hspace{2pt}prior\_web[which(prior\_web\textgreater0)] \textless- 1\\
      \noindent \hspace{2pt}write.csv(prior\_web\_para\_only, file=``prior\_web\_para\_only.csv", quote=F)\\
      \end{em}

      % % # read in the data
      % prior_web_data=read.csv('../../data/Salix_example/tree_level_interaxn_all_plants_traits_size.csv')
      % # just keep what we need
      % prior_web_data <- prior_web_data[,8:26]

      % # Build a web with interactions=1 for any parasitoid on any galler
      % prior_web=data.frame()

      % # each column contains all interactions for a particular parasitoid-galler combination
      % for(column in 1:ncol(prior_web_data)){
      %   # the column name gives the species which makes the gall, followed by the species emerging from the gall
      %   # they need to be separated 
      %   galler_emerged=strsplit(colnames(prior_web_data)[column], "_")
      %   galler = galler_emerged[[1]][1]
      %   emerged = galler_emerged[[1]][2]
        
      %   # the strength of the interaction is the sum of the column (number of galls across all branches sampled)
      %   linkstrength = sum(prior_web_data[,column])
      %   # put that into a dataframe
      %   prior_web[as.character(galler),as.character(emerged)] <- linkstrength
      % } 

      % # Make the naS into 0
      % prior_web[is.na(prior_web)] <- 0
      % # Make the non-zero elements into 1
      % prior_web[prior_web>0] <- 1
      % # some of the emergers were the gallers, remove those columns if we're only
      % # interested in galler-parasitoid interactions
      % prior_web_para_only <- prior_web[,c(2:6,8:9,12)]
      % write.csv(prior_web_para_only, file="binary_prior_web_para_only.csv", quote=F)

      \clearpage


    \subsection*{Prior and posterior distributions}

      Using the binary networks described above, we obtained prior parameters $\alpha$=2.51 and $\beta$=1.89 for the \emph{Salix}-galler component and $\alpha$=1.34, $\beta$=9.49 for the galler-natural enemy component of the network. After calculating these prior parameters, we were then able to estimate the posterior distribution of interaction probabilities given the additional information in our dataset.
      For species where no co-occurrences were observed ($n=0$), we can calculate the estimates for the mean and variance of $\lambda_{ij}$ directly from the prior parameters following equations~\ref{mean} and~\ref{variance} (see \emph{Appendix S1} for R implementation). For the \emph{Salix}-galler network, the prior distribution was: $\bar\lambda$=0.570, var($\lambda$)=0.056. The prior distribution for the galler-natural enemy network was: $\bar\lambda$=0.124, var($\lambda$)=0.010. 


      For a pair of species with some observed co-occurrences ($n>0$), we can update the prior distribution with these data. If we consider only pairs of species which were observed to co-occur but not to interact, $k_{ij}$ is always 0 and only $n_{ij}$ will vary between species pairs, giving $\alpha'$=$\alpha$ and $\beta'$=$\beta + n_{ij}$. As the most extreme case, consider a pair of species which co-occurred at all 374 sites and was never observed to interact. Using the priors described above, our distributions would become 
      $\bar\lambda_{ij}$=6.63 $\times$ 10$^{-3}$, var($\lambda_{ij}$)=1.74 $\times$ 10$^{-5}$ for the \emph{Salix}-galler network and 
      $\bar\lambda_{ij}$=3.49 $\times$ 10$^{-3}$, var($\lambda_{ij}$)=9.03 $\times$ 10$^{-6}$ for the galler-natural enemy network. Distributions for both network components were close to 0 with small variance about our estimate of $\lambda$; species $i$ and $j$ are unlikely to interact at sites or times not included in our sample.


    \subsection*{Credible intervals and sampling requirements}

      For most pairs of species $i$ and $j$, however, $n_{ij}$ was much less than 374 and our posterior mean and variance therefore retain more of the influence of the prior. We can see this in the increasing means and variances as we decrease $n_{ij}$ (Fig.~\ref{Salix_pdfs}). The 95\% credible interval around the estimate of $\lambda$ also widens as $n_{ij}$ decreases, from (0.001, 0.017) and (\textless0.001, 0.11) for hypothetical \emph{Salix}-galler and galler-natural enemy pairs that might be observed co-occurring at all 374 sites without any observed interaction to (0.152,0.931) and (0.008, 0.364) for \emph{Salix}-galler and galler-natural enemy pairs that were never observed co-occurring.


      If we want to be 95\% confident that the interaction probability for two species in the \emph{Salix}-galler network is below 0.1, 0.05, or 0.01, we would need 51, 106, and 550 observed co-occurrences with no observed interaction, respectively (Fig.~\ref{Salix_cdfs}; see function samples\_for\_threshold in~\emph{Appendix S1}). The number of samples required to be 95\% confident that the interaction probability between galler and natural enemy species is below a threshold also increases quickly as the threshold decreases; we would need 25, 62, and 352 observed co-occurrence with no observed interaction for threshold interaction probabilities of 0.1, 0.05, and 0.01, respectively. 


    \subsection*{Scaling up to network metrics}




    \bibliographystyle{ecollett} 
    \bibliography{MyCollection}

\end{document}


